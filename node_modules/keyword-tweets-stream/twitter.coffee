#Load the http module

https = require("https")
oauth = require("oauth")

#Get the tweets stream
getTweetsStream = (keyword, callback) ->
  
  #Twitter api urls
  filter_stream_url = "https://stream.twitter.com/1.1/statuses/filter.json?track=" + keyword
  request_token_url = "https://api.twitter.com/oauth/request_token"
  access_token_url = "https://api.twitter.com/oauth/access_token"
  @oauth = new oauth.OAuth(request_token_url, access_token_url, "Scz0rYVE6std7725VYFhKtqDo", "LzftandOIMicMxei2Quv6OOqmmPTafTqJ8aaAmV4UhPq8maWLb", "1.0", null, "HMAC-SHA1", null,
    Accept: "*/*"
    Connection: "close"
    "User-Agent": "theyoyofox"
  )
  request = @oauth.post(filter_stream_url, "2713892300-nl4a5qpxs0bNNE1hXzTY46Xdmu6RbC3oqancFVa", "QKgddx595YUKuWnFABnTIBLYeJ1rgK8kLkzQ9pmtLlSLH", null)
  request.on "response", (response) ->
    
    #set chunk encoding
    response.setEncoding "utf8"
    fullChunk = ""
    response.on "data", (chunk) ->
      data = chunk.toString()
      data = @lastLineData + data  if @lastLineData
      lines = data.split("\n")
      @lastLineData = lines.splice(lines.length - 1, 1)[0]
      last_char = data.slice(-3)
      if last_char[0] is "}"
        clean_data = data.substr(0, data.length - 2)
        tweet = JSON.parse(clean_data)
        callback tweet.text
      return

    response.on "end", ->
      console.log "Disconnected"
      return

    response.on "error", (error) ->
      console.log "ERROR: " + error.message
      return

    return

  request.on "error", (error) ->
    console.log "ERROR: " + error.message
    return

  request.end()
  return

#Export api functions for the module
module.exports.getTweetsStream = getTweetsStream